<?php
/**
 * @CreateTime:   2021/1/3 1:21 上午
 * @Author:       huizhang  <2788828128@qq.com>
 * @Copyright:    copyright(2020) Easyswoole all rights reserved
 * @Description:  消费进程
 */

namespace Huizhang\UniversalQueue\Core;

use EasySwoole\Component\Process\Socket\AbstractUnixProcess;
use EasySwoole\Component\Process\Socket\UnixProcessConfig;
use Huizhang\UniversalQueue\Unit\QueueDataCache;
use Swoole\Coroutine;
use Swoole\Coroutine\Socket;

class ConsumerProcess extends AbstractUnixProcess
{

    public function __construct(UnixProcessConfig $config)
    {
        /** @var $queue Queue */
        $queue = $config->getArg();
        QueueDataCache::getInstance()->init($queue);
        parent::__construct($config);
    }

    public function run($arg)
    {
        /** @var $queue Queue */
        $queue = $arg;
        $queue->getConsumer()->queue = $queue;
        $queue->getConsumer()->init();
        for ($i = 0; $i < $queue->getCoroutineNum(); $i++) {
            Coroutine::create(function () use ($queue, $i) {
                $cacheFile = QueueDataCache::getCacheFile($queue->getAlias(), $i);
                $errorCacheFile = QueueDataCache::getCacheFile($queue->getAlias(), 'error');
                $failTimes = 0;
                while (true) {
                    try {
                        $data = QueueDataCache::read($errorCacheFile, $queue->getLimit());
                        if (empty($data)) {
                            $data = QueueDataCache::read($cacheFile, $queue->getLimit());
                            $isErrData = false;
                        } else {
                            $isErrData = true;
                        }
                        if (empty($data)) {
                            $data = $queue->getDriver()->pop($queue, $queue->getLimit());
                            if (empty($data)) {
                                QueueDataCache::write($cacheFile, $data);
                            }
                        }

                        if (!empty($data)) {
                            $queue->getConsumer()->deal($data);
                            if ($isErrData) {
                                QueueDataCache::rem($errorCacheFile, count($data));
                            } else {
                                QueueDataCache::rem($cacheFile, count($data));
                            }
                        }

                        $failTimes = 0;
                    } catch (\Throwable $e) {
                        ++$failTimes;
                        if ($failTimes >= 3) {
                            QueueDataCache::mergeAtoBAndUnlinkA($cacheFile, $errorCacheFile);
                            break;
                        }
                    }
                    Coroutine::sleep(0.01);
                }
            });
        }
        return parent::run($arg); // TODO: Change the autogenerated stub
    }

    function onAccept(Socket $socket)
    {
        // TODO: Implement onAccept() method.
    }
}
